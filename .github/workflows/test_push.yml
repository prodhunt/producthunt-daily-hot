name: Test Push Permissions

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘
    inputs:
      test_message:
        description: 'æµ‹è¯•æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'Test push verification'
        type: string

permissions:
  contents: write  # å…è®¸æŽ¨é€åˆ°ä»“åº“
  actions: write   # å…è®¸è§¦å‘å…¶ä»–å·¥ä½œæµ

jobs:
  test_push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: çŽ¯å¢ƒä¿¡æ¯æ£€æŸ¥
      run: |
        echo "ðŸ” çŽ¯å¢ƒä¿¡æ¯æ£€æŸ¥"
        echo "================================"
        echo "ä»“åº“: ${{ github.repository }}"
        echo "åˆ†æ”¯: ${{ github.ref }}"
        echo "Actor: ${{ github.actor }}"
        echo "äº‹ä»¶: ${{ github.event_name }}"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "Git çŠ¶æ€: $(git status --short || echo 'æ— å˜æ›´')"
        echo "================================"

    - name: æ£€æŸ¥ Secrets é…ç½®
      run: |
        echo "ðŸ”‘ æ£€æŸ¥ Secrets é…ç½®"
        echo "================================"
        
        if [ -n "${{ secrets.PAT }}" ]; then
          echo "âœ… PAT Secret å·²é…ç½®"
          echo "PAT é•¿åº¦: ${#PAT_VALUE} å­—ç¬¦"
        else
          echo "âŒ PAT Secret æœªé…ç½®"
        fi
        
        if [ -n "${{ github.token }}" ]; then
          echo "âœ… GITHUB_TOKEN å¯ç”¨"
        else
          echo "âŒ GITHUB_TOKEN ä¸å¯ç”¨"
        fi
        
        echo "================================"
      env:
        PAT_VALUE: ${{ secrets.PAT }}

    - name: åˆ›å»ºæµ‹è¯•æ–‡ä»¶
      run: |
        echo "ðŸ“ åˆ›å»ºæµ‹è¯•æ–‡ä»¶"
        echo "================================"
        
        # ç¡®ä¿ data ç›®å½•å­˜åœ¨
        mkdir -p data
        
        # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
        TEST_FILE="data/push-test-$(date '+%Y%m%d-%H%M%S').md"
        
        cat > "$TEST_FILE" << EOF
        # æŽ¨é€æµ‹è¯•æ–‡ä»¶
        
        ## æµ‹è¯•ä¿¡æ¯
        - **åˆ›å»ºæ—¶é—´**: $(date)
        - **å·¥ä½œæµ**: ${{ github.workflow }}
        - **è¿è¡ŒID**: ${{ github.run_id }}
        - **æµ‹è¯•æ¶ˆæ¯**: ${{ github.event.inputs.test_message }}
        - **è§¦å‘è€…**: ${{ github.actor }}
        
        ## çŽ¯å¢ƒä¿¡æ¯
        - **ä»“åº“**: ${{ github.repository }}
        - **åˆ†æ”¯**: ${{ github.ref }}
        - **æäº¤SHA**: ${{ github.sha }}
        
        ## æµ‹è¯•ç›®çš„
        æ­¤æ–‡ä»¶ç”¨äºŽéªŒè¯ GitHub Actions çš„æŽ¨é€æƒé™æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚
        
        ---
        *æ­¤æ–‡ä»¶ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼Œç”¨äºŽæµ‹è¯•ç›®çš„*
        EOF
        
        echo "âœ… æµ‹è¯•æ–‡ä»¶å·²åˆ›å»º: $TEST_FILE"
        echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
        echo "--------------------------------"
        head -10 "$TEST_FILE"
        echo "--------------------------------"
        echo "æ–‡ä»¶å¤§å°: $(wc -l < "$TEST_FILE") è¡Œ"

    - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
      id: check_changes
      run: |
        echo "ðŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´"
        echo "================================"
        
        # æ£€æŸ¥ Git çŠ¶æ€
        git status --porcelain
        
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "å˜æ›´çš„æ–‡ä»¶:"
          git status --short
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´"
        fi
        
        echo "================================"

    - name: é…ç½® Git ç”¨æˆ·
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        echo "âš™ï¸ é…ç½® Git ç”¨æˆ·ä¿¡æ¯"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        echo "âœ… Git ç”¨æˆ·é…ç½®å®Œæˆ"

    - name: æäº¤å˜æ›´
      if: steps.check_changes.outputs.has_changes == 'true'
      id: commit
      run: |
        echo "ðŸ“ æäº¤å˜æ›´"
        echo "================================"
        
        # æ·»åŠ æ–‡ä»¶
        git add .
        
        # æäº¤å˜æ›´
        COMMIT_MESSAGE="ðŸ§ª Test push: ${{ github.event.inputs.test_message }} ($(date '+%Y-%m-%d %H:%M:%S UTC'))"
        git commit -m "$COMMIT_MESSAGE"
        
        echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        echo "âœ… å˜æ›´å·²æäº¤"
        echo "æäº¤ä¿¡æ¯: $COMMIT_MESSAGE"
        echo "æäº¤SHA: $(git rev-parse HEAD)"
        echo "================================"

    - name: æŽ¨é€å˜æ›´ (ä½¿ç”¨ PAT)
      if: steps.check_changes.outputs.has_changes == 'true' && secrets.PAT != ''
      id: push_pat
      run: |
        echo "ðŸš€ ä½¿ç”¨ PAT æŽ¨é€å˜æ›´"
        echo "================================"
        
        # ä½¿ç”¨ PAT æŽ¨é€
        if git push https://${{ secrets.PAT }}@github.com/${{ github.repository }}.git HEAD:main; then
          echo "push_success=true" >> $GITHUB_OUTPUT
          echo "push_method=PAT" >> $GITHUB_OUTPUT
          echo "âœ… ä½¿ç”¨ PAT æŽ¨é€æˆåŠŸ"
        else
          echo "push_success=false" >> $GITHUB_OUTPUT
          echo "âŒ ä½¿ç”¨ PAT æŽ¨é€å¤±è´¥"
          exit 1
        fi
        
        echo "================================"

    - name: æŽ¨é€å˜æ›´ (ä½¿ç”¨ GITHUB_TOKEN)
      if: steps.check_changes.outputs.has_changes == 'true' && secrets.PAT == '' 
      id: push_token
      run: |
        echo "ðŸš€ ä½¿ç”¨ GITHUB_TOKEN æŽ¨é€å˜æ›´"
        echo "================================"
        
        # ä½¿ç”¨ GITHUB_TOKEN æŽ¨é€
        if git push https://${{ github.token }}@github.com/${{ github.repository }}.git HEAD:main; then
          echo "push_success=true" >> $GITHUB_OUTPUT
          echo "push_method=GITHUB_TOKEN" >> $GITHUB_OUTPUT
          echo "âœ… ä½¿ç”¨ GITHUB_TOKEN æŽ¨é€æˆåŠŸ"
        else
          echo "push_success=false" >> $GITHUB_OUTPUT
          echo "âŒ ä½¿ç”¨ GITHUB_TOKEN æŽ¨é€å¤±è´¥"
          exit 1
        fi
        
        echo "================================"

    - name: æµ‹è¯• Hugo å·¥ä½œæµè§¦å‘ (å¯é€‰)
      if: success() && steps.check_changes.outputs.has_changes == 'true'
      continue-on-error: true  # å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­
      run: |
        echo "ðŸ”— æµ‹è¯• Hugo å·¥ä½œæµè§¦å‘"
        echo "================================"
        
        if [ -n "${{ secrets.PAT }}" ]; then
          echo "å°è¯•è§¦å‘ Hugo å‘å¸ƒå·¥ä½œæµ..."
          
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.PAT }}" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{
              "event_type": "content-generated",
              "client_payload": {
                "triggered_by": "test_push",
                "test_mode": true,
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
                "commit_sha": "${{ steps.commit.outputs.commit_sha }}"
              }
            }'
          
          if [ $? -eq 0 ]; then
            echo "âœ… Hugo å·¥ä½œæµè§¦å‘æˆåŠŸ"
          else
            echo "âš ï¸ Hugo å·¥ä½œæµè§¦å‘å¤±è´¥ï¼ˆè¿™æ˜¯å¯é€‰æ­¥éª¤ï¼‰"
          fi
        else
          echo "âš ï¸ è·³è¿‡ Hugo å·¥ä½œæµè§¦å‘ï¼ˆç¼ºå°‘ PATï¼‰"
        fi
        
        echo "================================"

    - name: æµ‹è¯•ç»“æžœæ€»ç»“
      if: always()
      run: |
        echo "## ðŸ“Š æŽ¨é€æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æµ‹è¯•æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **ä»“åº“**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æµ‹è¯•æ¶ˆæ¯**: ${{ github.event.inputs.test_message }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### é…ç½®æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ secrets.PAT }}" ]; then
          echo "- âœ… PAT Secret å·²é…ç½®" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ PAT Secret æœªé…ç½®" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ github.token }}" ]; then
          echo "- âœ… GITHUB_TOKEN å¯ç”¨" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ GITHUB_TOKEN ä¸å¯ç”¨" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
          echo "- âœ… æ–‡ä»¶å˜æ›´æ£€æµ‹: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.push_pat.outputs.push_success }}" == "true" ]; then
            echo "- âœ… æŽ¨é€ç»“æžœ: æˆåŠŸ (ä½¿ç”¨ PAT)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.push_token.outputs.push_success }}" == "true" ]; then
            echo "- âœ… æŽ¨é€ç»“æžœ: æˆåŠŸ (ä½¿ç”¨ GITHUB_TOKEN)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ æŽ¨é€ç»“æžœ: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æŽ¨é€" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "ðŸŽ‰ **æ€»ä½“çŠ¶æ€**: æµ‹è¯•æˆåŠŸï¼æŽ¨é€æƒé™æ­£å¸¸å·¥ä½œã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **æ€»ä½“çŠ¶æ€**: æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥æƒé™é…ç½®ã€‚" >> $GITHUB_STEP_SUMMARY
        fi

    - name: æ¸…ç†æµ‹è¯•æ–‡ä»¶ (å¯é€‰)
      if: always()
      continue-on-error: true
      run: |
        echo "ðŸ§¹ æ¸…ç†æµ‹è¯•æ–‡ä»¶"
        echo "================================"
        
        # å¯é€‰ï¼šåˆ é™¤æµ‹è¯•æ–‡ä»¶ï¼ˆå¦‚æžœä¸æƒ³ä¿ç•™ï¼‰
        # find data -name "push-test-*.md" -mtime +1 -delete
        
        echo "â„¹ï¸ æµ‹è¯•æ–‡ä»¶å·²ä¿ç•™ï¼Œå¯æ‰‹åŠ¨åˆ é™¤"
        echo "å½“å‰æµ‹è¯•æ–‡ä»¶:"
        ls -la data/push-test-*.md 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•æ–‡ä»¶"
        echo "================================"
