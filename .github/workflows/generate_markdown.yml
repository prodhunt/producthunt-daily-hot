name: Generate Daily Markdown

on:
  schedule:
    - cron: '0 9 * * *'  # æ¯å¤©UTCæ—¶é—´æ—©ä¸Š9:00ï¼ˆåŒ—äº¬æ—¶é—´ä¸‹åˆ5:00è‡ªåŠ¨è¿è¡Œï¼‰
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºè°ƒè¯•å’Œæµ‹è¯•ï¼‰
    inputs:
      debug_mode:
        description: 'è°ƒè¯•æ¨¡å¼ï¼ˆè¾“å‡ºæ›´å¤šæ—¥å¿—ä¿¡æ¯ï¼‰'
        required: false
        default: false
        type: boolean
      force_run:
        description: 'å¼ºåˆ¶è¿è¡Œï¼ˆå³ä½¿æœ‰æœ€è¿‘çš„ä»£ç æäº¤ï¼‰'
        required: false
        default: false
        type: boolean
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆä¸æäº¤åˆ°ä»“åº“ï¼‰'
        required: false
        default: false
        type: boolean

permissions:
  contents: write  # å…è®¸æ¨é€åˆ°ä»“åº“
  actions: write   # å…è®¸è§¦å‘å…¶ä»–å·¥ä½œæµ

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout auto-content branch
      uses: actions/checkout@v4
      with:
        ref: auto-content  # ä½¿ç”¨ä¸“é—¨çš„å†…å®¹åˆ†æ”¯
        fetch-depth: 0     # è·å–å®Œæ•´å†å²
        token: ${{ secrets.PAT || github.token }}

    - name: Smart sync from main branch
      run: |
        echo "ğŸ”„ æ™ºèƒ½åŒæ­¥ main åˆ†æ”¯çš„æœ€æ–°ä»£ç ..."

        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # è·å– main åˆ†æ”¯çš„æœ€æ–°ä»£ç 
        git fetch origin main

        # æ£€æŸ¥ main åˆ†æ”¯æ˜¯å¦æœ‰æ–°çš„æäº¤
        MAIN_COMMIT=$(git rev-parse origin/main)
        LAST_SYNC_COMMIT=$(git log --grep="ğŸ”„ Auto-sync code from main branch" --format="%H" -1 2>/dev/null || echo "")

        if [ "$MAIN_COMMIT" != "$LAST_SYNC_COMMIT" ]; then
          echo "ğŸ“ æ£€æµ‹åˆ° main åˆ†æ”¯æœ‰æ–°æäº¤ï¼Œå¼€å§‹åŒæ­¥..."

          # åªåŒæ­¥ä»£ç æ–‡ä»¶ï¼Œä¸åŒæ­¥å†…å®¹æ–‡ä»¶
          git checkout origin/main -- scripts/ 2>/dev/null || echo "scripts/ æ— å˜æ›´"
          git checkout origin/main -- .github/ 2>/dev/null || echo ".github/ æ— å˜æ›´"
          git checkout origin/main -- requirements.txt 2>/dev/null || echo "requirements.txt æ— å˜æ›´"
          git checkout origin/main -- *.py 2>/dev/null || echo "Python æ–‡ä»¶æ— å˜æ›´"

          # åªåŒæ­¥æ ¹ç›®å½•çš„ README.mdï¼Œä¸åŒæ­¥ data ç›®å½•çš„ md æ–‡ä»¶
          git checkout origin/main -- README.md 2>/dev/null || echo "README.md æ— å˜æ›´"

          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ğŸ”„ Auto-sync code from main branch $(date '+%Y-%m-%d %H:%M:%S UTC') - commit: ${MAIN_COMMIT:0:7}"
            echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
          else
            echo "â„¹ï¸ æ²¡æœ‰ä»£ç å˜æ›´éœ€è¦åŒæ­¥"
          fi
        else
          echo "â„¹ï¸ main åˆ†æ”¯æ²¡æœ‰æ–°æäº¤ï¼Œè·³è¿‡åŒæ­¥"
        fi

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install openai>=1.0.0 python-dotenv beautifulsoup4 pytz requests google-generativeai
        pip install python-wordpress-xmlrpc
        pip list  # æ˜¾ç¤ºå·²å®‰è£…çš„åŒ…åŠå…¶ç‰ˆæœ¬

    - name: Generate Markdown with Optimizations
      env:
        # LLMæä¾›å•†é…ç½®
        LLM_PROVIDER: ${{ secrets.LLM_PROVIDER || 'deepseek' }}

        # OpenAIé…ç½®
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4o-2024-08-06' }}
        OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE }}

        # Geminié…ç½®
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_MODEL: ${{ secrets.GEMINI_MODEL || 'gemini-2.0-flash' }}
        GEMINI_API_BASE: ${{ secrets.GEMINI_API_BASE }}

        # DeepSeeké…ç½®
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL || 'deepseek-chat' }}
        DEEPSEEK_API_BASE: ${{ secrets.DEEPSEEK_API_BASE }}

        # OpenRouteré…ç½®
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL || 'deepseek/deepseek-chat-v3-0324' }}
        OPENROUTER_API_BASE: ${{ secrets.OPENROUTER_API_BASE }}

        # Product Hunté…ç½®
        PRODUCTHUNT_DEVELOPER_TOKEN: ${{ secrets.PRODUCTHUNT_DEVELOPER_TOKEN }}
      run: |
        echo "ğŸš€ ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬ç”Ÿæˆå†…å®¹..."
        echo "LLMæä¾›å•†: $LLM_PROVIDER"
        echo "å¼€å§‹æ—¶é—´: $(date)"

        # ä½¿ç”¨ä¼˜åŒ–åçš„è„šæœ¬
        python scripts/scripts_product_hunt_list_to_md.py

        echo "å®Œæˆæ—¶é—´: $(date)"
        echo "âœ… å†…å®¹ç”Ÿæˆå®Œæˆ"

    - name: æ£€æŸ¥ç”Ÿæˆçš„å†…å®¹
      run: |
        echo "ğŸ“‹ æ£€æŸ¥ç”Ÿæˆçš„å†…å®¹..."
        if [ -d "data" ] && [ "$(ls -A data/*.md 2>/dev/null)" ]; then
          echo "âœ… å‘ç°ç”Ÿæˆçš„å†…å®¹æ–‡ä»¶ï¼š"
          ls -la data/
          echo "CONTENT_GENERATED=true" >> $GITHUB_ENV
        else
          echo "â„¹ï¸ æ²¡æœ‰å‘ç°æ–°çš„å†…å®¹æ–‡ä»¶"
          echo "CONTENT_GENERATED=false" >> $GITHUB_ENV
        fi

    - name: ç›´æ¥æ¨é€å†…å®¹åˆ°Hugoä»“åº“
      if: env.CONTENT_GENERATED == 'true'
      run: |
        echo "ğŸš€ ç›´æ¥æ¨é€ç”Ÿæˆçš„å†…å®¹åˆ°Hugoä»“åº“..."

        # æ£€æŸ¥æ˜¯å¦é…ç½®äº†Hugoä»“åº“
        if [ -z "${{ secrets.HUGO_REPO_URL }}" ]; then
          echo "âŒ æœªé…ç½®HUGO_REPO_URL"
          echo "è¯·åœ¨GitHub Secretsä¸­è®¾ç½®HUGO_REPO_URLï¼ˆæ ¼å¼ï¼šusername/repo-nameï¼‰"
          exit 1
        fi

        # é…ç½®Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # å…‹éš†Hugoä»“åº“
        echo "ğŸ“¥ å…‹éš†Hugoä»“åº“: ${{ secrets.HUGO_REPO_URL }}"
        git clone https://${{ secrets.PAT }}@github.com/${{ secrets.HUGO_REPO_URL }}.git hugo-repo

        # åˆ›å»ºHugoå†…å®¹ç›®å½•
        mkdir -p hugo-repo/content/posts

        # å¤åˆ¶ç”Ÿæˆçš„å†…å®¹æ–‡ä»¶
        echo "ğŸ“ å¤åˆ¶ç”Ÿæˆçš„å†…å®¹æ–‡ä»¶åˆ°Hugoä»“åº“..."
        cp data/*.md hugo-repo/content/posts/

        # è¿›å…¥Hugoä»“åº“ç›®å½•
        cd hugo-repo

        # æ˜¾ç¤ºå¤åˆ¶çš„æ–‡ä»¶
        echo "ğŸ“‹ å¤åˆ¶çš„æ–‡ä»¶ï¼š"
        ls -la content/posts/

        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“ æ£€æµ‹åˆ°å†…å®¹å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          echo "å˜æ›´çš„æ–‡ä»¶ï¼š"
          git status --short

          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add .

          # æäº¤å˜æ›´
          git commit -m "ğŸ¤– Auto-generated Product Hunt daily content $(date '+%Y-%m-%d %H:%M:%S UTC')"

          # è·å–æœ€æ–°çš„è¿œç¨‹æ›´æ”¹ï¼Œé¿å…å†²çª
          echo "ğŸ”„ è·å–æœ€æ–°çš„è¿œç¨‹æ›´æ”¹..."
          git fetch origin main

          # å°è¯•rebaseï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨merge
          if git rebase origin/main; then
            echo "âœ… Rebase æˆåŠŸ"
          else
            echo "âš ï¸ Rebase å¤±è´¥ï¼Œå°è¯• merge..."
            git rebase --abort
            git merge origin/main -m "ğŸ”„ Merge remote changes"
          fi

          # æ¨é€åˆ°Hugoä»“åº“
          echo "ğŸš€ æ¨é€åˆ°Hugoä»“åº“..."
          git push origin main

          echo "âœ… æˆåŠŸæ¨é€å†…å®¹åˆ°Hugoä»“åº“"
          echo "ğŸŒ Hugoç½‘ç«™å°†è‡ªåŠ¨æ›´æ–°"
        else
          echo "â„¹ï¸ æ²¡æœ‰å†…å®¹å˜æ›´ï¼Œè·³è¿‡æ¨é€"
        fi

    - name: æ¸…ç†æœ¬åœ°ç”Ÿæˆçš„æ–‡ä»¶
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†æœ¬åœ°ç”Ÿæˆçš„æ–‡ä»¶..."
        rm -rf data/*.md 2>/dev/null || echo "æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ–‡ä»¶"
        echo "âœ… æ¸…ç†å®Œæˆ"

    - name: å·¥ä½œæµæ€»ç»“
      if: always()
      run: |
        echo "## ğŸ“Š ä¼˜åŒ–ç‰ˆå†…å®¹ç”Ÿæˆæ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **LLM æä¾›å•†**: ${{ env.LLM_PROVIDER }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ä½¿ç”¨è„šæœ¬**: scripts_product_hunt_list_to_md.py (ä¼˜åŒ–ç‰ˆ)" >> $GITHUB_STEP_SUMMARY

        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        if [ -f "data/producthunt-daily-$(date -u -d '1 day ago' '+%Y-%m-%d').md" ]; then
          file_size=$(wc -l < "data/producthunt-daily-$(date -u -d '1 day ago' '+%Y-%m-%d').md")
          echo "- **ç”Ÿæˆæ–‡ä»¶**: producthunt-daily-$(date -u -d '1 day ago' '+%Y-%m-%d').md ($file_size è¡Œ)" >> $GITHUB_STEP_SUMMARY
        fi

        # æ˜¾ç¤ºä¼˜åŒ–åŠŸèƒ½
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸš€ ä¼˜åŒ–åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Hugo Front Matter è‡ªåŠ¨ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ™ºèƒ½æ ‡ç­¾å’Œå…³é”®è¯ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Product Hunt å›¾ç‰‡è‡ªåŠ¨é€‰æ‹©" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ¸…æ´ç¿»è¯‘ï¼ˆæ— ç¿»è¯‘è¯´æ˜ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆ10ä¸ªç²¾é€‰äº§å“ï¼‰" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" == "success" ] && [ "${{ env.CONTENT_GENERATED }}" == "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **çŠ¶æ€**: å†…å®¹ç”ŸæˆæˆåŠŸï¼Œå·²ç›´æ¥æ¨é€åˆ°Hugoä»“åº“" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ **Hugoç½‘ç«™**: å°†è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ job.status }}" == "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ **çŠ¶æ€**: å·¥ä½œæµè¿è¡ŒæˆåŠŸï¼Œä½†æ²¡æœ‰ç”Ÿæˆæ–°å†…å®¹" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **çŠ¶æ€**: å†…å®¹ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi