name: Generate Daily Markdown

on:
  schedule:
    - cron: '01 7 * * *'  # æ¯å¤©UTCæ—¶é—´æ—©ä¸Š7:01ï¼ˆåŒ—äº¬æ—¶é—´ä¸‹åˆ3:01è‡ªåŠ¨è¿è¡Œï¼‰
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      force_run:
        description: 'å¼ºåˆ¶è¿è¡Œï¼ˆå³ä½¿æœ‰æœ€è¿‘çš„ä»£ç æäº¤ï¼‰'
        required: false
        default: false
        type: boolean

permissions:
  contents: write  # å…è®¸æ¨é€åˆ°ä»“åº“
  actions: write   # å…è®¸è§¦å‘å…¶ä»–å·¥ä½œæµ

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout auto-content branch
      uses: actions/checkout@v4
      with:
        ref: auto-content  # ä½¿ç”¨ä¸“é—¨çš„å†…å®¹åˆ†æ”¯
        fetch-depth: 0     # è·å–å®Œæ•´å†å²ï¼Œä»¥ä¾¿åŒæ­¥ä»£ç 

    - name: Sync code from main branch
      run: |
        echo "ğŸ”„ åŒæ­¥ main åˆ†æ”¯çš„ä»£ç åˆ° auto-content åˆ†æ”¯..."

        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # è·å– main åˆ†æ”¯çš„æœ€æ–°ä»£ç 
        git fetch origin main

        # åŒæ­¥ä»£ç æ–‡ä»¶ï¼ˆä¸åŒ…æ‹¬ data ç›®å½•ï¼‰
        git checkout origin/main -- scripts/ || echo "scripts/ ç›®å½•ä¸å­˜åœ¨æˆ–æ— å˜æ›´"
        git checkout origin/main -- .github/ || echo ".github/ ç›®å½•ä¸å­˜åœ¨æˆ–æ— å˜æ›´"
        git checkout origin/main -- requirements.txt || echo "requirements.txt ä¸å­˜åœ¨æˆ–æ— å˜æ›´"
        git checkout origin/main -- *.py || echo "Python æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— å˜æ›´"
        git checkout origin/main -- *.md || echo "Markdown æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— å˜æ›´"

        # æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç æ›´æ”¹éœ€è¦æäº¤
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“ æ£€æµ‹åˆ°ä»£ç æ›´æ”¹ï¼Œæäº¤åŒæ­¥..."
          git add .
          git commit -m "ğŸ”„ Auto-sync code from main branch $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
        else
          echo "â„¹ï¸ æ²¡æœ‰ä»£ç æ›´æ”¹éœ€è¦åŒæ­¥"
        fi

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install openai>=1.0.0 python-dotenv beautifulsoup4 pytz requests google-generativeai
        pip install python-wordpress-xmlrpc
        pip list  # æ˜¾ç¤ºå·²å®‰è£…çš„åŒ…åŠå…¶ç‰ˆæœ¬

    - name: Generate Markdown with Optimizations
      env:
        # LLMæä¾›å•†é…ç½®
        LLM_PROVIDER: ${{ secrets.LLM_PROVIDER || 'deepseek' }}

        # OpenAIé…ç½®
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4o-2024-08-06' }}
        OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE }}

        # Geminié…ç½®
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_MODEL: ${{ secrets.GEMINI_MODEL || 'gemini-2.0-flash' }}
        GEMINI_API_BASE: ${{ secrets.GEMINI_API_BASE }}

        # DeepSeeké…ç½®
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL || 'deepseek-chat' }}
        DEEPSEEK_API_BASE: ${{ secrets.DEEPSEEK_API_BASE }}

        # OpenRouteré…ç½®
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL || 'deepseek/deepseek-chat-v3-0324' }}
        OPENROUTER_API_BASE: ${{ secrets.OPENROUTER_API_BASE }}

        # Product Hunté…ç½®
        PRODUCTHUNT_DEVELOPER_TOKEN: ${{ secrets.PRODUCTHUNT_DEVELOPER_TOKEN }}
      run: |
        echo "ğŸš€ ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬ç”Ÿæˆå†…å®¹..."
        echo "LLMæä¾›å•†: $LLM_PROVIDER"
        echo "å¼€å§‹æ—¶é—´: $(date)"

        # ä½¿ç”¨ä¼˜åŒ–åçš„è„šæœ¬
        python scripts/scripts_product_hunt_list_to_md.py

        echo "å®Œæˆæ—¶é—´: $(date)"
        echo "âœ… å†…å®¹ç”Ÿæˆå®Œæˆ"

    - name: Commit and Push changes
      run: |
        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # æ·»åŠ æ–‡ä»¶
        git add .

        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          git commit -m "ğŸ¤– Auto-generated daily content $(date '+%Y-%m-%d %H:%M:%S UTC')"

          # æ¨é€å˜æ›´åˆ°å†…å®¹åˆ†æ”¯ï¼ˆä½¿ç”¨ PAT æˆ– GITHUB_TOKENï¼‰
          if [ -n "${{ secrets.PAT }}" ]; then
            echo "ğŸ”‘ ä½¿ç”¨ PAT æ¨é€åˆ° auto-content åˆ†æ”¯..."
            git push https://${{ secrets.PAT }}@github.com/${{ github.repository }}.git HEAD:auto-content
          else
            echo "ğŸ”‘ ä½¿ç”¨ GITHUB_TOKEN æ¨é€åˆ° auto-content åˆ†æ”¯..."
            git push https://${{ github.token }}@github.com/${{ github.repository }}.git HEAD:auto-content
          fi

          echo "âœ… æˆåŠŸæ¨é€åˆ°ä»“åº“"
        else
          echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
        fi

    - name: è§¦å‘ Hugo å‘å¸ƒå·¥ä½œæµ
      if: success()
      run: |
        echo "ğŸš€ è§¦å‘ Hugo å‘å¸ƒå·¥ä½œæµ..."

        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.PAT }}" \
          -H "Content-Type: application/json" \
          https://api.github.com/repos/${{ github.repository }}/dispatches \
          -d '{
            "event_type": "content-generated",
            "client_payload": {
              "triggered_by": "generate_markdown",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
              "commit_sha": "${{ github.sha }}"
            }
          }'

        if [ $? -eq 0 ]; then
          echo "âœ… æˆåŠŸè§¦å‘ Hugo å‘å¸ƒå·¥ä½œæµ"
        else
          echo "âŒ è§¦å‘ Hugo å‘å¸ƒå·¥ä½œæµå¤±è´¥"
          exit 1
        fi

    - name: å·¥ä½œæµæ€»ç»“
      if: always()
      run: |
        echo "## ğŸ“Š ä¼˜åŒ–ç‰ˆå†…å®¹ç”Ÿæˆæ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **LLM æä¾›å•†**: ${{ env.LLM_PROVIDER }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ä½¿ç”¨è„šæœ¬**: scripts_product_hunt_list_to_md.py (ä¼˜åŒ–ç‰ˆ)" >> $GITHUB_STEP_SUMMARY

        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        if [ -f "data/producthunt-daily-$(date -u -d '1 day ago' '+%Y-%m-%d').md" ]; then
          file_size=$(wc -l < "data/producthunt-daily-$(date -u -d '1 day ago' '+%Y-%m-%d').md")
          echo "- **ç”Ÿæˆæ–‡ä»¶**: producthunt-daily-$(date -u -d '1 day ago' '+%Y-%m-%d').md ($file_size è¡Œ)" >> $GITHUB_STEP_SUMMARY
        fi

        # æ˜¾ç¤ºä¼˜åŒ–åŠŸèƒ½
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸš€ ä¼˜åŒ–åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Hugo Front Matter è‡ªåŠ¨ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ™ºèƒ½æ ‡ç­¾å’Œå…³é”®è¯ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Product Hunt å›¾ç‰‡è‡ªåŠ¨é€‰æ‹©" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ¸…æ´ç¿»è¯‘ï¼ˆæ— ç¿»è¯‘è¯´æ˜ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆ10ä¸ªç²¾é€‰äº§å“ï¼‰" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" == "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **çŠ¶æ€**: å†…å®¹ç”ŸæˆæˆåŠŸï¼Œå·²è§¦å‘ Hugo å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **çŠ¶æ€**: å†…å®¹ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi