name: Generate Daily Markdown

on:
  schedule:
    - cron: '0 9 * * *'  # æ¯å¤©UTCæ—¶é—´æ—©ä¸Š9:00ï¼ˆåŒ—äº¬æ—¶é—´ä¸‹åˆ5:00è‡ªåŠ¨è¿è¡Œï¼‰
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºŽè°ƒè¯•å’Œæµ‹è¯•ï¼‰
    inputs:
      debug_mode:
        description: 'è°ƒè¯•æ¨¡å¼ï¼ˆè¾“å‡ºæ›´å¤šæ—¥å¿—ä¿¡æ¯ï¼‰'
        required: false
        default: false
        type: boolean
      force_run:
        description: 'å¼ºåˆ¶è¿è¡Œï¼ˆå³ä½¿æœ‰æœ€è¿‘çš„ä»£ç æäº¤ï¼‰'
        required: false
        default: false
        type: boolean
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆä¸æäº¤åˆ°ä»“åº“ï¼‰'
        required: false
        default: false
        type: boolean

permissions:
  contents: write  # å…è®¸æŽ¨é€åˆ°ä»“åº“
  actions: write   # å…è®¸è§¦å‘å…¶ä»–å·¥ä½œæµ

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install openai>=1.0.0 python-dotenv beautifulsoup4 pytz requests google-generativeai
        pip install python-wordpress-xmlrpc
        pip list  # æ˜¾ç¤ºå·²å®‰è£…çš„åŒ…åŠå…¶ç‰ˆæœ¬

    - name: Generate Markdown with Optimizations
      env:
        # LLMæä¾›å•†é…ç½®
        LLM_PROVIDER: ${{ secrets.LLM_PROVIDER || 'deepseek' }}

        # OpenAIé…ç½®
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4o-2024-08-06' }}
        OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE }}

        # Geminié…ç½®
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_MODEL: ${{ secrets.GEMINI_MODEL || 'gemini-2.0-flash' }}
        GEMINI_API_BASE: ${{ secrets.GEMINI_API_BASE }}

        # DeepSeeké…ç½®
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL || 'deepseek-chat' }}
        DEEPSEEK_API_BASE: ${{ secrets.DEEPSEEK_API_BASE }}

        # OpenRouteré…ç½®
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL || 'deepseek/deepseek-chat-v3-0324' }}
        OPENROUTER_API_BASE: ${{ secrets.OPENROUTER_API_BASE }}

        # Product Hunté…ç½®
        PRODUCTHUNT_DEVELOPER_TOKEN: ${{ secrets.PRODUCTHUNT_DEVELOPER_TOKEN }}
      run: |
        echo "ðŸš€ ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬ç”Ÿæˆå†…å®¹..."
        echo "LLMæä¾›å•†: $LLM_PROVIDER"
        echo "å¼€å§‹æ—¶é—´: $(date)"

        # ä½¿ç”¨ä¼˜åŒ–åŽçš„è„šæœ¬
        python scripts/scripts_product_hunt_list_to_md.py

        echo "å®Œæˆæ—¶é—´: $(date)"
        echo "âœ… å†…å®¹ç”Ÿæˆå®Œæˆ"

    - name: æ£€æŸ¥ç”Ÿæˆçš„å†…å®¹
      run: |
        echo "ðŸ“‹ æ£€æŸ¥ç”Ÿæˆçš„å†…å®¹..."
        if [ -d "data" ] && [ "$(ls -A data/*.md 2>/dev/null)" ]; then
          echo "âœ… å‘çŽ°ç”Ÿæˆçš„å†…å®¹æ–‡ä»¶ï¼š"
          ls -la data/
          echo "CONTENT_GENERATED=true" >> $GITHUB_ENV
        else
          echo "â„¹ï¸ æ²¡æœ‰å‘çŽ°æ–°çš„å†…å®¹æ–‡ä»¶"
          echo "CONTENT_GENERATED=false" >> $GITHUB_ENV
        fi

    - name: ç›´æŽ¥æŽ¨é€å†…å®¹åˆ°Hugoä»“åº“
      if: env.CONTENT_GENERATED == 'true'
      run: |
        echo "ðŸš€ ç›´æŽ¥æŽ¨é€ç”Ÿæˆçš„å†…å®¹åˆ°Hugoä»“åº“..."

        # æ£€æŸ¥æ˜¯å¦é…ç½®äº†Hugoä»“åº“
        if [ -z "${{ secrets.HUGO_REPO_URL }}" ]; then
          echo "âŒ æœªé…ç½®HUGO_REPO_URL"
          echo "è¯·åœ¨GitHub Secretsä¸­è®¾ç½®HUGO_REPO_URLï¼ˆæ ¼å¼ï¼šusername/repo-nameï¼‰"
          exit 1
        fi

        # é…ç½®Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # å…‹éš†Hugoä»“åº“
        echo "ðŸ“¥ å…‹éš†Hugoä»“åº“: ${{ secrets.HUGO_REPO_URL }}"
        git clone https://${{ secrets.PAT }}@github.com/${{ secrets.HUGO_REPO_URL }}.git hugo-repo

        # åˆ›å»ºHugoå†…å®¹ç›®å½•
        mkdir -p hugo-repo/content/news

        # å¤åˆ¶ç”Ÿæˆçš„å†…å®¹æ–‡ä»¶
        echo "ðŸ“ å¤åˆ¶ç”Ÿæˆçš„å†…å®¹æ–‡ä»¶åˆ°Hugoä»“åº“..."
        cp data/*.md hugo-repo/content/news/

        # è¿›å…¥Hugoä»“åº“ç›®å½•
        cd hugo-repo

        # æ˜¾ç¤ºå¤åˆ¶çš„æ–‡ä»¶
        echo "ðŸ“‹ å¤åˆ¶çš„æ–‡ä»¶ï¼š"
        ls -la content/news/

        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -n "$(git status --porcelain)" ]; then
          echo "ðŸ“ æ£€æµ‹åˆ°å†…å®¹å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          echo "å˜æ›´çš„æ–‡ä»¶ï¼š"
          git status --short

          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add .

          # æäº¤å˜æ›´
          git commit -m "ðŸ¤– Auto-generated Product Hunt daily content $(date '+%Y-%m-%d %H:%M:%S UTC')"

          # èŽ·å–æœ€æ–°çš„è¿œç¨‹æ›´æ”¹ï¼Œé¿å…å†²çª
          echo "ðŸ”„ èŽ·å–æœ€æ–°çš„è¿œç¨‹æ›´æ”¹..."
          git fetch origin main

          # å°è¯•rebaseï¼Œå¦‚æžœå¤±è´¥åˆ™ä½¿ç”¨merge
          if git rebase origin/main; then
            echo "âœ… Rebase æˆåŠŸ"
          else
            echo "âš ï¸ Rebase å¤±è´¥ï¼Œå°è¯• merge..."
            git rebase --abort
            git merge origin/main -m "ðŸ”„ Merge remote changes"
          fi

          # æŽ¨é€åˆ°Hugoä»“åº“
          echo "ðŸš€ æŽ¨é€åˆ°Hugoä»“åº“..."
          git push origin main

          echo "âœ… æˆåŠŸæŽ¨é€å†…å®¹åˆ°Hugoä»“åº“"
          echo "ðŸŒ Hugoç½‘ç«™å°†è‡ªåŠ¨æ›´æ–°"
        else
          echo "â„¹ï¸ æ²¡æœ‰å†…å®¹å˜æ›´ï¼Œè·³è¿‡æŽ¨é€"
        fi



    - name: å·¥ä½œæµæ€»ç»“
      if: always()
      run: |
        echo "## ðŸ“Š Product Hunt å†…å®¹ç”Ÿæˆæ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **LLM æä¾›å•†**: ${{ env.LLM_PROVIDER }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡ä»“åº“**: ${{ secrets.HUGO_REPO_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å·¥ä½œæµæ¨¡å¼**: ç›´æŽ¥æŽ¨é€æ¨¡å¼" >> $GITHUB_STEP_SUMMARY

        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        if [ -d "data" ] && [ "$(ls -A data/*.md 2>/dev/null)" ]; then
          echo "- **ç”Ÿæˆæ–‡ä»¶**: $(ls data/*.md | wc -l) ä¸ªæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶åˆ—è¡¨**: $(ls data/*.md | xargs -n1 basename | tr '\n' ', ' | sed 's/,$//')" >> $GITHUB_STEP_SUMMARY
        fi

        # æ˜¾ç¤ºåŠŸèƒ½ç‰¹æ€§
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ åŠŸèƒ½ç‰¹æ€§" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Hugo Stack Front Matter è‡ªåŠ¨ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ™ºèƒ½æ ‡ç­¾å’Œå…³é”®è¯ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Product Hunt å›¾ç‰‡è‡ªåŠ¨é€‰æ‹©" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ¸…æ´ç¿»è¯‘ï¼ˆæ— ç¿»è¯‘è¯´æ˜Žï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆ10ä¸ªç²¾é€‰äº§å“ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ç®€åŒ–æž¶æž„ï¼ˆç›´æŽ¥æŽ¨é€åˆ°Hugoä»“åº“ï¼‰" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" == "success" ] && [ "${{ env.CONTENT_GENERATED }}" == "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **çŠ¶æ€**: å†…å®¹ç”ŸæˆæˆåŠŸï¼Œå·²ç›´æŽ¥æŽ¨é€åˆ°Hugo Stackä»“åº“" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Hugoç½‘ç«™**: å°†è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒæ–°å†…å®¹" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ job.status }}" == "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ **çŠ¶æ€**: å·¥ä½œæµè¿è¡ŒæˆåŠŸï¼Œä½†æ²¡æœ‰ç”Ÿæˆæ–°å†…å®¹" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **çŠ¶æ€**: å†…å®¹ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
        fi