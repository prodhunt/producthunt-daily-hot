name: Publish to Hugo

on:
  # æŽ¥æ”¶æ¥è‡ªå…¶ä»–å·¥ä½œæµçš„è§¦å‘
  repository_dispatch:
    types: [content-generated]
  
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘åŠŸèƒ½
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'å¼ºåˆ¶å‘å¸ƒï¼ˆå³ä½¿æ²¡æœ‰æ–°å†…å®¹ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  publish_to_hugo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout å½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹éœ€è¦å‘å¸ƒ
        id: check_content
        run: |
          if [ -d "data" ] && [ "$(ls -A data/*.md 2>/dev/null)" ]; then
            echo "has_content=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘çŽ°å¾…å‘å¸ƒçš„å†…å®¹æ–‡ä»¶"
            ls -la data/*.md
          else
            echo "has_content=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ æœªå‘çŽ°å¾…å‘å¸ƒçš„å†…å®¹æ–‡ä»¶"
          fi

      - name: Checkout Hugo ä»“åº“
        if: steps.check_content.outputs.has_content == 'true' || github.event.inputs.force_publish == 'true'
        uses: actions/checkout@v4
        with:
          repository: hugoflow/producthunt-daily-stack
          token: ${{ secrets.HUGO_PUSH_TOKEN }}
          path: hugo-site
          fetch-depth: 1

      - name: åˆ›å»ºå†…å®¹ç›®å½•
        if: steps.check_content.outputs.has_content == 'true' || github.event.inputs.force_publish == 'true'
        run: |
          mkdir -p hugo-site/content/news
          echo "ðŸ“ ç¡®ä¿å†…å®¹ç›®å½•å­˜åœ¨"

      - name: æ‹·è´ md æ–‡ä»¶åˆ° Hugo ä»“åº“
        if: steps.check_content.outputs.has_content == 'true' || github.event.inputs.force_publish == 'true'
        run: |
          if [ -f data/*.md ]; then
            cp data/*.md hugo-site/content/news/
            echo "âœ… æˆåŠŸå¤åˆ¶å†…å®¹æ–‡ä»¶åˆ° Hugo ä»“åº“"
            echo "å¤åˆ¶çš„æ–‡ä»¶ï¼š"
            ls -la hugo-site/content/news/
          else
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°è¦å¤åˆ¶çš„æ–‡ä»¶"
          fi

      - name: é…ç½® Git ä¿¡æ¯
        if: steps.check_content.outputs.has_content == 'true' || github.event.inputs.force_publish == 'true'
        run: |
          cd hugo-site
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: æ£€æŸ¥å˜æ›´å¹¶æäº¤
        if: steps.check_content.outputs.has_content == 'true' || github.event.inputs.force_publish == 'true'
        id: commit_changes
        run: |
          cd hugo-site
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ æ£€æµ‹åˆ°å†…å®¹å˜æ›´"
            git status --short
            
            # æ·»åŠ å¹¶æäº¤å˜æ›´
            git add content/news/
            git commit -m "auto: publish Product Hunt daily $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "âœ… æˆåŠŸæäº¤å˜æ›´"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å†…å®¹å˜æ›´"
          fi

      - name: æŽ¨é€åˆ° Hugo ä»“åº“
        if: steps.commit_changes.outputs.has_changes == 'true'
        run: |
          cd hugo-site
          git push
          echo "ðŸš€ æˆåŠŸæŽ¨é€åˆ° Hugo ä»“åº“"

      - name: å‘å¸ƒæ€»ç»“
        run: |
          echo "## ðŸ“Š Hugo å‘å¸ƒæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç›®æ ‡ä»“åº“**: hugoflow/producthunt-daily-stack" >> $GITHUB_STEP_SUMMARY
          echo "- **å†…å®¹è·¯å¾„**: content/news/" >> $GITHUB_STEP_SUMMARY
          echo "- **æœ‰å†…å®¹**: ${{ steps.check_content.outputs.has_content }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æœ‰å˜æ›´**: ${{ steps.commit_changes.outputs.has_changes || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY

          # æ˜¾ç¤ºå‘å¸ƒçš„å†…å®¹ä¿¡æ¯
          if [ "${{ steps.check_content.outputs.has_content }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“„ å‘å¸ƒå†…å®¹" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Hugo Front Matter (æ ‡ç­¾ã€å…³é”®è¯ã€å°é¢)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ä¼˜åŒ–ç¿»è¯‘å†…å®¹ï¼ˆæ— ç¿»è¯‘è¯´æ˜Žï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Product Hunt ç²¾é€‰äº§å“" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… SEO ä¼˜åŒ–å†…å®¹" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.commit_changes.outputs.has_changes }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **çŠ¶æ€**: å‘å¸ƒæˆåŠŸåˆ° Hugo ä»“åº“" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ **çŠ¶æ€**: æ— éœ€å‘å¸ƒï¼ˆå†…å®¹æ— å˜æ›´ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
