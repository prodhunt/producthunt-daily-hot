name: Diagnose Hugo Sync Issues

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘

jobs:
  diagnose:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€æŸ¥ auto-content åˆ†æ”¯
      uses: actions/checkout@v4
      with:
        ref: auto-content
        fetch-depth: 1

    - name: è¯Šæ–­ auto-content åˆ†æ”¯çŠ¶æ€
      run: |
        echo "## ðŸ” auto-content åˆ†æ”¯è¯Šæ–­" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“ åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **å½“å‰åˆ†æ”¯**: $(git branch --show-current)" >> $GITHUB_STEP_SUMMARY
        echo "- **æœ€æ–°æäº¤**: $(git log -1 --oneline)" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤æ—¶é—´**: $(git log -1 --format='%ci')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“ ç›®å½•ç»“æž„" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -la >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“„ data ç›®å½•æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        if [ -d "data" ]; then
          echo "- âœ… data ç›®å½•å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la data/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥ MD æ–‡ä»¶
          md_count=$(ls data/*.md 2>/dev/null | wc -l)
          echo "- **MD æ–‡ä»¶æ•°é‡**: $md_count" >> $GITHUB_STEP_SUMMARY
          
          if [ $md_count -gt 0 ]; then
            echo "- **MD æ–‡ä»¶åˆ—è¡¨**:" >> $GITHUB_STEP_SUMMARY
            for file in data/*.md; do
              if [ -f "$file" ]; then
                size=$(wc -l < "$file")
                echo "  - $(basename "$file") ($size è¡Œ)" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi
        else
          echo "- âŒ data ç›®å½•ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: æ£€æŸ¥ Hugo ä»“åº“è®¿é—®æƒé™
      run: |
        echo "### ðŸ”‘ Hugo ä»“åº“æƒé™æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        
        if [ -z "${{ secrets.HUGO_PUSH_TOKEN }}" ]; then
          echo "- âŒ HUGO_PUSH_TOKEN æœªé…ç½®" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âœ… HUGO_PUSH_TOKEN å·²é…ç½®" >> $GITHUB_STEP_SUMMARY
          
          # æµ‹è¯•ä»“åº“è®¿é—®
          if curl -s -H "Authorization: token ${{ secrets.HUGO_PUSH_TOKEN }}" \
                  https://api.github.com/repos/hugoflow/producthunt-daily-stack > /dev/null; then
            echo "- âœ… å¯ä»¥è®¿é—® Hugo ä»“åº“" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ æ— æ³•è®¿é—® Hugo ä»“åº“" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: æ¨¡æ‹Ÿ Hugo å‘å¸ƒæµç¨‹
      run: |
        echo "### ðŸ§ª æ¨¡æ‹Ÿ Hugo å‘å¸ƒæµç¨‹" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥å†…å®¹
        if [ -d "data" ] && [ "$(ls -A data/*.md 2>/dev/null)" ]; then
          echo "- âœ… å‘çŽ°å¾…å‘å¸ƒçš„å†…å®¹æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          
          # æ¨¡æ‹Ÿæ£€å‡º Hugo ä»“åº“
          if [ -n "${{ secrets.HUGO_PUSH_TOKEN }}" ]; then
            echo "- ðŸ”„ å°è¯•å…‹éš† Hugo ä»“åº“..." >> $GITHUB_STEP_SUMMARY
            
            if git clone https://${{ secrets.HUGO_PUSH_TOKEN }}@github.com/hugoflow/producthunt-daily-stack.git hugo-test; then
              echo "- âœ… Hugo ä»“åº“å…‹éš†æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
              
              # æ£€æŸ¥ç›®æ ‡ç›®å½•
              mkdir -p hugo-test/content/news
              echo "- âœ… åˆ›å»ºç›®æ ‡ç›®å½•æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
              
              # æ¨¡æ‹Ÿå¤åˆ¶æ–‡ä»¶
              if ls data/*.md 1> /dev/null 2>&1; then
                cp data/*.md hugo-test/content/news/
                echo "- âœ… æ–‡ä»¶å¤åˆ¶æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
                echo "- **å¤åˆ¶çš„æ–‡ä»¶**:" >> $GITHUB_STEP_SUMMARY
                for file in hugo-test/content/news/*.md; do
                  if [ -f "$file" ]; then
                    echo "  - $(basename "$file")" >> $GITHUB_STEP_SUMMARY
                  fi
                done
              else
                echo "- âŒ æ²¡æœ‰æ‰¾åˆ°è¦å¤åˆ¶çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
              fi
              
              # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
              cd hugo-test
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              
              if [ -n "$(git status --porcelain)" ]; then
                echo "- âœ… æ£€æµ‹åˆ°å†…å®¹å˜æ›´ï¼Œå¯ä»¥æäº¤" >> $GITHUB_STEP_SUMMARY
                echo "- **å˜æ›´æ–‡ä»¶**:" >> $GITHUB_STEP_SUMMARY
                git status --short | while read line; do
                  echo "  - $line" >> $GITHUB_STEP_SUMMARY
                done
              else
                echo "- âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å†…å®¹å˜æ›´" >> $GITHUB_STEP_SUMMARY
              fi
              
            else
              echo "- âŒ Hugo ä»“åº“å…‹éš†å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- âŒ æ— æ³•æµ‹è¯•ï¼ŒHUGO_PUSH_TOKEN æœªé…ç½®" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- âŒ æœªå‘çŽ°å¾…å‘å¸ƒçš„å†…å®¹æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: æ£€æŸ¥æœ€è¿‘çš„å·¥ä½œæµè¿è¡Œ
      run: |
        echo "### ðŸ“Š æœ€è¿‘çš„å·¥ä½œæµè¿è¡Œ" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ secrets.PAT }}" ]; then
          echo "- ðŸ”„ èŽ·å–æœ€è¿‘çš„å·¥ä½œæµè¿è¡Œè®°å½•..." >> $GITHUB_STEP_SUMMARY
          
          # èŽ·å–å†…å®¹ç”Ÿæˆå·¥ä½œæµçš„æœ€è¿‘è¿è¡Œ
          curl -s -H "Authorization: token ${{ secrets.PAT }}" \
               "https://api.github.com/repos/${{ github.repository }}/actions/workflows/generate_markdown.yml/runs?per_page=3" \
               > generate_runs.json
          
          # èŽ·å– Hugo å‘å¸ƒå·¥ä½œæµçš„æœ€è¿‘è¿è¡Œ
          curl -s -H "Authorization: token ${{ secrets.PAT }}" \
               "https://api.github.com/repos/${{ github.repository }}/actions/workflows/publish-to-hugo.yml/runs?per_page=3" \
               > hugo_runs.json
          
          echo "- **å†…å®¹ç”Ÿæˆå·¥ä½œæµæœ€è¿‘è¿è¡Œ**:" >> $GITHUB_STEP_SUMMARY
          if command -v jq >/dev/null 2>&1; then
            jq -r '.workflow_runs[] | "  - \(.created_at): \(.conclusion // "running") (\(.html_url))"' generate_runs.json >> $GITHUB_STEP_SUMMARY
          else
            echo "  - (éœ€è¦ jq å·¥å…·è§£æž JSON)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **Hugo å‘å¸ƒå·¥ä½œæµæœ€è¿‘è¿è¡Œ**:" >> $GITHUB_STEP_SUMMARY
          if command -v jq >/dev/null 2>&1; then
            jq -r '.workflow_runs[] | "  - \(.created_at): \(.conclusion // "running") (\(.html_url))"' hugo_runs.json >> $GITHUB_STEP_SUMMARY
          else
            echo "  - (éœ€è¦ jq å·¥å…·è§£æž JSON)" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- âŒ æ— æ³•èŽ·å–å·¥ä½œæµè¿è¡Œè®°å½•ï¼ŒPAT æœªé…ç½®" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ç”Ÿæˆè¯Šæ–­å»ºè®®
      run: |
        echo "### ðŸ’¡ è¯Šæ–­å»ºè®®" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æ ¹æ®ä»¥ä¸Šæ£€æŸ¥ç»“æžœï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„é—®é¢˜ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **å†…å®¹ç”Ÿæˆé—®é¢˜**:" >> $GITHUB_STEP_SUMMARY
        echo "   - æ£€æŸ¥å†…å®¹ç”Ÿæˆå·¥ä½œæµæ˜¯å¦æˆåŠŸè¿è¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "   - ç¡®è®¤ auto-content åˆ†æ”¯æœ‰æœ€æ–°çš„ MD æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "2. **æƒé™é—®é¢˜**:" >> $GITHUB_STEP_SUMMARY
        echo "   - ç¡®è®¤ HUGO_PUSH_TOKEN å·²æ­£ç¡®é…ç½®" >> $GITHUB_STEP_SUMMARY
        echo "   - ç¡®è®¤ Token å¯¹ hugoflow/producthunt-daily-stack æœ‰å†™å…¥æƒé™" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "3. **å·¥ä½œæµè§¦å‘é—®é¢˜**:" >> $GITHUB_STEP_SUMMARY
        echo "   - æ£€æŸ¥ Hugo å‘å¸ƒå·¥ä½œæµæ˜¯å¦è¢«æ­£ç¡®è§¦å‘" >> $GITHUB_STEP_SUMMARY
        echo "   - ç¡®è®¤ repository_dispatch äº‹ä»¶é…ç½®æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "4. **æ–‡ä»¶å¤åˆ¶é—®é¢˜**:" >> $GITHUB_STEP_SUMMARY
        echo "   - æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™" >> $GITHUB_STEP_SUMMARY
        echo "   - ç¡®è®¤ç›®æ ‡ç›®å½•ç»“æž„æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
