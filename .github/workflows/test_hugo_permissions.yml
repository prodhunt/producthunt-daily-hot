name: Test Hugo Repository Permissions

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘
    inputs:
      test_message:
        description: 'æµ‹è¯•æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'Hugo permissions test'
        type: string

jobs:
  test_hugo_access:
    runs-on: ubuntu-latest
    
    steps:
    - name: çŽ¯å¢ƒä¿¡æ¯æ£€æŸ¥
      run: |
        echo "ðŸ” Hugo æƒé™æµ‹è¯•"
        echo "================================"
        echo "ç›®æ ‡ä»“åº“: hugoflow/producthunt-daily-stack"
        echo "æµ‹è¯•æ—¶é—´: $(date)"
        echo "æµ‹è¯•æ¶ˆæ¯: ${{ github.event.inputs.test_message }}"
        echo "================================"

    - name: æ£€æŸ¥ HUGO_PUSH_TOKEN
      id: check_token
      run: |
        echo "ðŸ”‘ æ£€æŸ¥ HUGO_PUSH_TOKEN"
        echo "================================"
        
        if [ -z "${{ secrets.HUGO_PUSH_TOKEN }}" ]; then
          echo "âŒ HUGO_PUSH_TOKEN æœªé…ç½®"
          echo "token_exists=false" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "âœ… HUGO_PUSH_TOKEN å·²é…ç½®"
          echo "token_exists=true" >> $GITHUB_OUTPUT
          echo "Token é•¿åº¦: ${#TOKEN_VALUE} å­—ç¬¦"
        fi
        
        echo "================================"
      env:
        TOKEN_VALUE: ${{ secrets.HUGO_PUSH_TOKEN }}

    - name: æµ‹è¯• API è®¿é—®æƒé™
      if: steps.check_token.outputs.token_exists == 'true'
      id: test_api
      run: |
        echo "ðŸŒ æµ‹è¯• GitHub API è®¿é—®æƒé™"
        echo "================================"
        
        # æµ‹è¯•åŸºæœ¬ API è®¿é—®
        echo "æµ‹è¯•ç”¨æˆ·ä¿¡æ¯..."
        if curl -s -H "Authorization: token ${{ secrets.HUGO_PUSH_TOKEN }}" \
                https://api.github.com/user > user_info.json; then
          
          username=$(cat user_info.json | grep -o '"login":"[^"]*"' | cut -d'"' -f4)
          echo "âœ… Token æœ‰æ•ˆï¼Œç”¨æˆ·: $username"
          echo "username=$username" >> $GITHUB_OUTPUT
        else
          echo "âŒ Token æ— æ•ˆæˆ– API è®¿é—®å¤±è´¥"
          echo "api_access=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # æµ‹è¯•ç›®æ ‡ä»“åº“è®¿é—®æƒé™
        echo ""
        echo "æµ‹è¯•ç›®æ ‡ä»“åº“è®¿é—®æƒé™..."
        if curl -s -H "Authorization: token ${{ secrets.HUGO_PUSH_TOKEN }}" \
                https://api.github.com/repos/hugoflow/producthunt-daily-stack > repo_info.json; then
          
          repo_name=$(cat repo_info.json | grep -o '"full_name":"[^"]*"' | cut -d'"' -f4)
          echo "âœ… å¯ä»¥è®¿é—®ä»“åº“: $repo_name"
          
          # æ£€æŸ¥æƒé™
          permissions=$(cat repo_info.json | grep -o '"permissions":{[^}]*}')
          echo "æƒé™ä¿¡æ¯: $permissions"
          
          if echo "$permissions" | grep -q '"push":true'; then
            echo "âœ… æœ‰æŽ¨é€æƒé™"
            echo "push_permission=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ²¡æœ‰æŽ¨é€æƒé™"
            echo "push_permission=false" >> $GITHUB_OUTPUT
          fi
          
          echo "api_access=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ æ— æ³•è®¿é—®ç›®æ ‡ä»“åº“"
          echo "api_access=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "================================"

    - name: æµ‹è¯•ä»“åº“å…‹éš†
      if: steps.test_api.outputs.api_access == 'true'
      id: test_clone
      run: |
        echo "ðŸ“¥ æµ‹è¯•ä»“åº“å…‹éš†"
        echo "================================"
        
        # å°è¯•å…‹éš†ä»“åº“
        if git clone https://${{ secrets.HUGO_PUSH_TOKEN }}@github.com/hugoflow/producthunt-daily-stack.git hugo-test; then
          echo "âœ… ä»“åº“å…‹éš†æˆåŠŸ"
          echo "clone_success=true" >> $GITHUB_OUTPUT
          
          cd hugo-test
          echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
          echo "æœ€æ–°æäº¤: $(git log -1 --oneline)"
          echo "ä»“åº“ç»“æž„:"
          ls -la
          
          # æ£€æŸ¥ content/news ç›®å½•
          if [ -d "content/news" ]; then
            echo "âœ… content/news ç›®å½•å­˜åœ¨"
            echo "çŽ°æœ‰æ–‡ä»¶æ•°é‡: $(ls content/news/*.md 2>/dev/null | wc -l)"
          else
            echo "âš ï¸ content/news ç›®å½•ä¸å­˜åœ¨ï¼Œå°†éœ€è¦åˆ›å»º"
          fi
          
        else
          echo "âŒ ä»“åº“å…‹éš†å¤±è´¥"
          echo "clone_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "================================"

    - name: æµ‹è¯•æ–‡ä»¶åˆ›å»ºå’ŒæŽ¨é€
      if: steps.test_clone.outputs.clone_success == 'true'
      id: test_push
      run: |
        echo "ðŸ“ æµ‹è¯•æ–‡ä»¶åˆ›å»ºå’ŒæŽ¨é€"
        echo "================================"
        
        cd hugo-test
        
        # é…ç½® Git ç”¨æˆ·
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p content/news
        
        # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
        TEST_FILE="content/news/hugo-test-$(date '+%Y%m%d-%H%M%S').md"
        
        cat > "$TEST_FILE" << EOF
        ---
        title: "Hugo æƒé™æµ‹è¯•æ–‡ä»¶"
        date: $(date '+%Y-%m-%d')
        description: "æ­¤æ–‡ä»¶ç”¨äºŽæµ‹è¯• Hugo ä»“åº“çš„æŽ¨é€æƒé™"
        tags: ["æµ‹è¯•", "æƒé™éªŒè¯"]
        keywords: ["Hugo", "GitHub Actions", "æƒé™æµ‹è¯•"]
        ---
        
        # Hugo æƒé™æµ‹è¯•
        
        ## æµ‹è¯•ä¿¡æ¯
        - **åˆ›å»ºæ—¶é—´**: $(date)
        - **æµ‹è¯•æ¶ˆæ¯**: ${{ github.event.inputs.test_message }}
        - **ç”¨æˆ·**: ${{ steps.test_api.outputs.username }}
        - **å·¥ä½œæµ**: ${{ github.workflow }}
        - **è¿è¡ŒID**: ${{ github.run_id }}
        
        ## æµ‹è¯•ç›®çš„
        æ­¤æ–‡ä»¶ç”¨äºŽéªŒè¯ GitHub Actions å¯¹ Hugo ä»“åº“çš„æŽ¨é€æƒé™ã€‚
        
        ---
        *æ­¤æ–‡ä»¶ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼Œç”¨äºŽæƒé™æµ‹è¯•*
        EOF
        
        echo "âœ… æµ‹è¯•æ–‡ä»¶å·²åˆ›å»º: $TEST_FILE"
        
        # æ£€æŸ¥å˜æ›´
        if [ -n "$(git status --porcelain)" ]; then
          echo "ðŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          
          git add .
          git commit -m "ðŸ§ª Hugo permissions test: ${{ github.event.inputs.test_message }} ($(date '+%Y-%m-%d %H:%M:%S UTC'))"
          
          echo "ðŸš€ æŽ¨é€åˆ° Hugo ä»“åº“..."
          if git push origin main; then
            echo "âœ… æŽ¨é€æˆåŠŸï¼"
            echo "push_success=true" >> $GITHUB_OUTPUT
            
            # èŽ·å–æäº¤ä¿¡æ¯
            commit_sha=$(git rev-parse HEAD)
            echo "æäº¤SHA: $commit_sha"
            echo "commit_sha=$commit_sha" >> $GITHUB_OUTPUT
          else
            echo "âŒ æŽ¨é€å¤±è´¥"
            echo "push_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´"
          echo "push_success=false" >> $GITHUB_OUTPUT
        fi
        
        echo "================================"

    - name: æ¸…ç†æµ‹è¯•æ–‡ä»¶ (å¯é€‰)
      if: steps.test_push.outputs.push_success == 'true'
      continue-on-error: true
      run: |
        echo "ðŸ§¹ æ¸…ç†æµ‹è¯•æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰"
        echo "================================"
        
        cd hugo-test
        
        # å¯é€‰ï¼šåˆ é™¤æµ‹è¯•æ–‡ä»¶
        # git rm content/news/hugo-test-*.md
        # git commit -m "ðŸ§¹ Clean up test files"
        # git push origin main
        
        echo "â„¹ï¸ æµ‹è¯•æ–‡ä»¶å·²ä¿ç•™ï¼Œå¯æ‰‹åŠ¨åˆ é™¤"
        echo "æµ‹è¯•æ–‡ä»¶ä½ç½®: content/news/hugo-test-*.md"
        echo "================================"

    - name: æµ‹è¯•ç»“æžœæ€»ç»“
      if: always()
      run: |
        echo "## ðŸ“Š Hugo æƒé™æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æµ‹è¯•æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡ä»“åº“**: hugoflow/producthunt-daily-stack" >> $GITHUB_STEP_SUMMARY
        echo "- **æµ‹è¯•æ¶ˆæ¯**: ${{ github.event.inputs.test_message }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### é…ç½®æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check_token.outputs.token_exists }}" == "true" ]; then
          echo "- âœ… HUGO_PUSH_TOKEN å·²é…ç½®" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ HUGO_PUSH_TOKEN æœªé…ç½®" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### æƒé™æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.test_api.outputs.api_access }}" == "true" ]; then
          echo "- âœ… API è®¿é—®: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‘¤ ç”¨æˆ·: ${{ steps.test_api.outputs.username }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.test_api.outputs.push_permission }}" == "true" ]; then
            echo "- âœ… æŽ¨é€æƒé™: æœ‰æƒé™" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ æŽ¨é€æƒé™: æ— æƒé™" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- âŒ API è®¿é—®: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.test_clone.outputs.clone_success }}" == "true" ]; then
          echo "- âœ… ä»“åº“å…‹éš†: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ ä»“åº“å…‹éš†: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.test_push.outputs.push_success }}" == "true" ]; then
          echo "- âœ… æ–‡ä»¶æŽ¨é€: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ æäº¤SHA: ${{ steps.test_push.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ æ–‡ä»¶æŽ¨é€: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "ðŸŽ‰ **æ€»ä½“çŠ¶æ€**: Hugo æƒé™æµ‹è¯•æˆåŠŸï¼å¯ä»¥æ­£å¸¸æŽ¨é€åˆ°ç›®æ ‡ä»“åº“ã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **æ€»ä½“çŠ¶æ€**: Hugo æƒé™æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥ä»¥ä¸‹é…ç½®ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› ï¸ è§£å†³æ–¹æ¡ˆ" >> $GITHUB_STEP_SUMMARY
          echo "1. ç¡®ä¿ HUGO_PUSH_TOKEN å·²æ­£ç¡®é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "2. ç¡®ä¿ Token å¯¹åº”çš„ç”¨æˆ·å¯¹ hugoflow/producthunt-daily-stack æœ‰å†™å…¥æƒé™" >> $GITHUB_STEP_SUMMARY
          echo "3. æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ" >> $GITHUB_STEP_SUMMARY
          echo "4. è”ç³» hugoflow ç»„ç»‡ç®¡ç†å‘˜æ·»åŠ æƒé™" >> $GITHUB_STEP_SUMMARY
        fi
